<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>JobMatch Assistant ‚Äî by Mohamed Amine Makdad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui,
                   "SF Pro Display", "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020817 40%, #000 100%);
      color: #e5e7eb;
      min-height: 100vh;
    }
    .glass {
      background: rgba(9, 9, 15, 0.92);
      border: 1px solid rgba(148, 163, 253, 0.16);
      backdrop-filter: blur(22px);
    }
    .glass-soft {
      background: rgba(9, 9, 15, 0.85);
      border: 1px solid rgba(55, 65, 81, 0.6);
      backdrop-filter: blur(18px);
    }
    .glow {
      box-shadow: 0 22px 80px rgba(37, 99, 235, 0.35);
    }
    .btn-soft {
      transition: all 0.22s ease;
    }
    .btn-soft:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(15,23,42,0.55);
    }
    .job-card {
      transition: all 0.18s ease;
    }
    .job-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(15,23,42,0.75);
      border-color: rgba(56,189,248,0.5);
      background: rgba(5, 8, 15, 0.98);
    }
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(75,85,99,0.9);
      border-radius: 999px;
    }
  </style>
</head>
<body class="flex items-center justify-center px-4 py-10">
  <div class="w-full max-w-6xl mx-auto">
    <!-- Header -->
    <header class="mb-8 flex flex-col md:flex-row md:items-end md:justify-between gap-6">
      <div>
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full glass border border-cyan-500/30 text-xs text-cyan-300 mb-3">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
          JobMatch Assistant ‚Ä¢ CV ‚Üí Offres Indeed
        </div>
        <h1 class="text-4xl md:text-5xl font-semibold leading-tight bg-gradient-to-r from-cyan-400 via-blue-400 to-indigo-400 bg-clip-text text-transparent">
          Voir les vraies offres qui matchent TON CV.
        </h1>
        <p class="mt-3 text-sm md:text-base text-slate-400 max-w-2xl">
          Importe ton CV (PDF, Word, TXT), l‚Äôoutil analyse ton profil et r√©cup√®re des offres
          r√©elles sur Indeed Canada. Interface premium inspir√©e d‚ÄôApple & Tesla.
        </p>
      </div>

      <!-- Signature owner -->
      <div class="flex flex-col items-end gap-2 text-xs">
        <div class="glass px-3 py-2 rounded-2xl">
          <div class="text-slate-400 text-[10px] uppercase tracking-[0.16em]">Owner & Crafted by</div>
          <div class="text-slate-100 text-[11px] font-semibold">
            Mohamed Amine Makdad
          </div>
        </div>
      </div>
    </header>

    <!-- Main card -->
    <main class="glass rounded-3xl p-6 md:p-8 glow">
      <div class="flex flex-col lg:flex-row gap-8">
        <!-- LEFT : upload + actions -->
        <section class="w-full lg:w-1/3 space-y-4">
          <h2 class="text-sm font-semibold text-slate-200 tracking-wide">
            1. Importer ton CV
          </h2>
          <p class="text-xs text-slate-400">
            Formats accept√©s : <span class="text-cyan-300 font-medium">PDF, DOCX, DOC, TXT</span>.
            Ton CV reste localement, il est juste envoy√© √† ton API priv√©e pour analyse.
          </p>

          <label id="cvLabel"
            class="glass-soft border-dashed border-slate-600/60 rounded-2xl px-4 py-5 flex flex-col items-center gap-2 cursor-pointer btn-soft text-center">
            <span class="text-xs text-slate-400">Glisse ton CV ici ou clique pour s√©lectionner</span>
            <span class="px-3 py-1 rounded-full bg-slate-900/90 text-[10px] text-cyan-300 border border-cyan-500/20">
              Choisir un fichier
            </span>
            <input type="file" id="cvFile" class="hidden" accept=".pdf,.doc,.docx,.txt" />
          </label>

          <!-- Auto refresh -->
          <div class="space-y-1 mt-1">
            <div class="flex items-center justify-between">
              <span class="text-[10px] text-slate-300">
                Rafra√Æchissement automatique
              </span>
              <select id="autoRefresh"
                      class="bg-slate-950/90 border border-slate-700/80 text-[9px] text-slate-300 rounded-full px-2 py-1">
                <option value="0">Off</option>
                <option value="15">Chaque 15 min</option>
                <option value="30">Chaque 30 min</option>
              </select>
            </div>
            <p class="text-[9px] text-slate-500">
              Quand activ√©, l‚Äôoutil relance la recherche avec le m√™me CV (tu peux le laisser tourner).
            </p>
          </div>

          <button
            id="scanBtn"
            class="w-full mt-2 py-3 rounded-full bg-gradient-to-r from-cyan-400 via-blue-500 to-indigo-500 text-[13px] font-semibold text-slate-950 btn-soft">
            üöÄ Analyser mon CV & trouver des offres Indeed
          </button>

          <div id="status" class="mt-2 text-[10px] text-cyan-400 min-h-[14px]"></div>

          <div id="newBadge"
               class="hidden mt-1 text-[9px] text-emerald-300 px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-400/40">
            Nouvelles offres d√©tect√©es lors du dernier rafra√Æchissement.
          </div>
        </section>

        <!-- RIGHT : results -->
        <section class="w-full lg:w-2/3">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-sm font-semibold text-slate-200 tracking-wide">
              2. Offres Indeed correspondantes
            </h2>
            <span id="countBadge"
                  class="text-[10px] text-slate-400 px-2 py-1 rounded-full border border-slate-700/80">
              En attente d'analyse...
            </span>
          </div>
          <div id="jobs" class="space-y-3 max-h-[420px] overflow-y-auto pr-1">
            <!-- Cards jobs -->
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Modal contact HR -->
  <div id="modalBackdrop"
       class="fixed inset-0 bg-black/70 hidden items-center justify-center z-40 backdrop-blur">
    <div class="glass-soft w-full max-w-md rounded-2xl p-5 border border-slate-600/80">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-sm font-semibold text-slate-100">Pr√©parer un message pour HR</h3>
        <button onclick="closeModal()" class="text-slate-500 text-xs hover:text-cyan-300">‚úï</button>
      </div>

      <div class="space-y-2">
        <div>
          <label class="block text-[10px] text-slate-400 mb-1">Entreprise</label>
          <input id="modalCompany"
                 class="w-full bg-slate-900/90 border border-slate-700/80 rounded-lg px-2 py-1.5 text-[10px] text-slate-200"
                 readonly>
        </div>
        <div>
          <label class="block text-[10px] text-slate-400 mb-1">Poste</label>
          <input id="modalJobTitle"
                 class="w-full bg-slate-900/90 border border-slate-700/80 rounded-lg px-2 py-1.5 text-[10px] text-slate-200"
                 readonly>
        </div>
        <div>
          <label class="block text-[10px] text-slate-400 mb-1">Email HR (si tu le connais)</label>
          <input id="modalHrEmail"
                 placeholder="recrutement@entreprise.com"
                 class="w-full bg-slate-900/90 border border-slate-700/80 rounded-lg px-2 py-1.5 text-[10px] text-slate-200">
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-[10px] text-slate-400 mb-1">Ton nom</label>
            <input id="modalName"
                   placeholder="Ton nom complet"
                   class="w-full bg-slate-900/90 border border-slate-700/80 rounded-lg px-2 py-1.5 text-[10px] text-slate-200">
          </div>
          <div>
            <label class="block text-[10px] text-slate-400 mb-1">Ton email</label>
            <input id="modalEmail"
                   placeholder="ton.email@exemple.com"
                   class="w-full bg-slate-900/90 border border-slate-700/80 rounded-lg px-2 py-1.5 text-[10px] text-slate-200">
          </div>
        </div>
        <div>
          <label class="block text-[10px] text-slate-400 mb-1">R√©sum√© rapide de ton profil</label>
          <textarea id="modalSummary"
                    class="w-full bg-slate-900/90 border border-slate-700/80 rounded-lg px-2 py-1.5 text-[10px] text-slate-200 min-h-[70px]"
                    placeholder="Support informatique, logistique, banque, vente, etc. selon ton CV."></textarea>
        </div>
      </div>

      <div class="flex justify-end gap-2 mt-3">
        <button onclick="closeModal()"
                class="px-3 py-1.5 rounded-full text-[10px] text-slate-400 border border-slate-600/80 hover:text-cyan-300 hover:border-cyan-400/70">
          Annuler
        </button>
        <button id="btnGenerateEmail"
                class="px-4 py-1.5 rounded-full text-[10px] font-semibold bg-gradient-to-r from-cyan-400 to-blue-500 text-slate-950 btn-soft">
          G√©n√©rer le mail
        </button>
      </div>

      <div id="emailPreview"
           class="mt-3 text-[9px] text-slate-300 whitespace-pre-wrap max-h-40 overflow-y-auto border-t border-slate-700/70 pt-2"></div>
    </div>
  </div>

  <script>
    // URL de ton backend (Render)
    const BACKEND_BASE = "https://jobmatch-backend-teh8.onrender.com";

    const cvInput = document.getElementById("cvFile");
    const cvLabel = document.getElementById("cvLabel");
    const scanBtn = document.getElementById("scanBtn");
    const statusEl = document.getElementById("status");
    const jobsEl = document.getElementById("jobs");
    const countBadge = document.getElementById("countBadge");
    const autoRefreshSelect = document.getElementById("autoRefresh");
    const newBadge = document.getElementById("newBadge");

    let currentFile = null;
    let autoRefreshId = null;
    let lastJobKeys = new Set();
    let selectedJob = null;

    cvLabel.addEventListener("click", () => cvInput.click());

    cvInput.addEventListener("change", () => {
      currentFile = cvInput.files[0] || null;
      if (currentFile) {
        cvLabel.innerHTML = `
          <div class="flex flex-col items-center gap-2">
            <span class="text-xs text-emerald-300 font-semibold">
              ‚úì CV import√© avec succ√®s
            </span>
            <span class="text-[10px] text-slate-400 break-all">
              ${currentFile.name} (${(currentFile.size/1024).toFixed(1)} KB)
            </span>
            <span class="px-3 py-1 rounded-full bg-slate-900/90 text-[10px] text-cyan-300 border border-cyan-500/20">
              Changer de fichier
            </span>
          </div>
        `;
      }
    });

    scanBtn.addEventListener("click", () => {
      if (!currentFile) {
        alert("S√©lectionne ton CV avant de lancer l'analyse.");
        return;
      }
      fetchJobs(false);
    });

    autoRefreshSelect.addEventListener("change", () => {
      setupAutoRefresh();
    });

    function setupAutoRefresh() {
      if (autoRefreshId) {
        clearInterval(autoRefreshId);
        autoRefreshId = null;
      }
      const minutes = parseInt(autoRefreshSelect.value || "0", 10);
      if (minutes > 0) {
        autoRefreshId = setInterval(() => {
          if (currentFile) fetchJobs(true);
        }, minutes * 60 * 1000);
      }
    }

    async function fetchJobs(isAuto = false) {
      newBadge.classList.add("hidden");
      statusEl.classList.remove("text-red-400");
      statusEl.classList.add("text-cyan-400");

      statusEl.textContent = isAuto
        ? "Actualisation des offres Indeed‚Ä¶"
        : "Analyse de ton CV et recherche d'offres Indeed...";
      scanBtn.disabled = true;
      scanBtn.classList.add("opacity-60", "cursor-wait");

      const formData = new FormData();
      formData.append("cv", currentFile);

      const url = `${BACKEND_BASE}/api/match?recent_minutes=0&only_paid=true`;

      try {
        const res = await fetch(url, {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          let msg = "Erreur lors de l'analyse (backend).";
          try {
            const err = await res.json();
            if (err.detail) msg = err.detail;
          } catch {}
          throw new Error(msg);
        }

        const jobs = await res.json();

        countBadge.textContent = `${jobs.length} offre${jobs.length > 1 ? "s" : ""}`;
        statusEl.textContent = jobs.length
          ? (isAuto ? "Liste d'offres mise √† jour." : "Analyse termin√©e. R√©sultats ci-dessous.")
          : "Aucune offre trouv√©e pour ce CV pour l'instant.";

        const newKeys = new Set();
        let hasNew = false;

        jobsEl.innerHTML = "";
        jobs.forEach(job => {
          const key = `${job.title}-${job.company}-${job.url}`;
          newKeys.add(key);
          if (isAuto && !lastJobKeys.has(key)) {
            hasNew = true;
          }
          jobsEl.appendChild(createJobCard(job, isAuto && !lastJobKeys.has(key)));
        });

        if (isAuto && hasNew) {
          newBadge.classList.remove("hidden");
        }

        lastJobKeys = newKeys;
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Erreur : " + e.message;
        statusEl.classList.remove("text-cyan-400");
        statusEl.classList.add("text-red-400");
        countBadge.textContent = "Erreur";
      } finally {
        scanBtn.disabled = false;
        scanBtn.classList.remove("opacity-60", "cursor-wait");
      }
    }

    function createJobCard(job, highlightNew) {
      const card = document.createElement("div");
      card.className =
        "job-card glass-soft rounded-2xl p-4 border border-slate-700/70 flex flex-col gap-1";
      if (highlightNew) {
        card.classList.add("ring-1", "ring-emerald-400/60");
      }

      const title = document.createElement("div");
      title.className = "text-sm font-semibold text-slate-100";
      title.textContent = job.title;

      const meta = document.createElement("div");
      meta.className = "text-[10px] text-slate-400";
      meta.textContent = `${job.company} ‚Ä¢ ${job.location}`;

      const dateRow = document.createElement("div");
      dateRow.className = "text-[9px] text-slate-500";
      if (job.published_at) {
        dateRow.textContent = `Date sur Indeed : ${job.published_at}`;
      } else {
        dateRow.textContent = "Date sur Indeed : non pr√©cis√©e";
      }

      const snippet = document.createElement("div");
      snippet.className = "text-[10px] text-slate-500";
      snippet.textContent = job.snippet;

      const bottom = document.createElement("div");
      bottom.className = "flex items-center justify-between mt-2 gap-2";

      const link = document.createElement("a");
      link.href = job.url;
      link.target = "_blank";
      link.className = "text-[10px] text-cyan-400 hover:underline";
      link.textContent = "Voir l‚Äôoffre sur Indeed";

      const right = document.createElement("div");
      right.className = "flex items-center gap-2";

      const score = document.createElement("div");
      score.className =
        "px-2 py-1 rounded-full text-[9px] text-cyan-300 bg-cyan-500/10 border border-cyan-500/30";
      score.textContent = `Pertinence ${Math.round(job.match_score * 100)}%`;

      const contactBtn = document.createElement("button");
      contactBtn.className =
        "px-3 py-1 rounded-full text-[9px] text-slate-900 bg-gradient-to-r from-cyan-400 to-blue-500 btn-soft";
      contactBtn.textContent = "Contacter HR (optionnel)";
      contactBtn.onclick = () => openModal(job);

      right.appendChild(score);
      right.appendChild(contactBtn);

      bottom.appendChild(link);
      bottom.appendChild(right);

      card.appendChild(title);
      card.appendChild(meta);
      card.appendChild(dateRow);
      card.appendChild(snippet);
      card.appendChild(bottom);

      return card;
    }

    // -------- Modal HR --------
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalCompany = document.getElementById("modalCompany");
    const modalJobTitle = document.getElementById("modalJobTitle");
    const modalHrEmail = document.getElementById("modalHrEmail");
    const modalName = document.getElementById("modalName");
    const modalEmail = document.getElementById("modalEmail");
    const modalSummary = document.getElementById("modalSummary");
    const emailPreview = document.getElementById("emailPreview");
    const btnGenerateEmail = document.getElementById("btnGenerateEmail");

    function openModal(job) {
      selectedJob = job;
      modalCompany.value = job.company;
      modalJobTitle.value = job.title;
      modalHrEmail.value = "";
      modalName.value = "";
      modalEmail.value = "";
      modalSummary.value = "";
      emailPreview.textContent = "";
      modalBackdrop.classList.remove("hidden");
      modalBackdrop.classList.add("flex");
    }

    function closeModal() {
      modalBackdrop.classList.add("hidden");
      modalBackdrop.classList.remove("flex");
      selectedJob = null;
    }

    window.closeModal = closeModal;

    btnGenerateEmail.addEventListener("click", async () => {
      if (!selectedJob) return;

      const payload = {
        job_title: modalJobTitle.value,
        company: modalCompany.value,
        hr_email: modalHrEmail.value,
        candidate_name: modalName.value || "Votre nom",
        candidate_email: modalEmail.value || "votre.email@exemple.com",
        cv_summary: modalSummary.value || "Profil li√© √† ce type de poste (voir CV joint)."
      };

      try {
        const res = await fetch(`${BACKEND_BASE}/api/contact-hr`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || "Erreur g√©n√©ration mail.");
        }

        const data = await res.json();
        emailPreview.textContent =
`√Ä : ${data.to}
Sujet : ${data.subject}

${data.body}

üëâ Copie-colle ce message dans ton Gmail
   (plus tard : int√©gration Gmail directe).`;
      } catch (e) {
        emailPreview.textContent = "Erreur : " + e.message;
      }
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !modalBackdrop.classList.contains("hidden")) {
        closeModal();
      }
    });
  </script>
</body>
</html>
